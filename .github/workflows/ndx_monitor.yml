name: ğŸ“ˆ NDX Daily Market Monitor

on:
  schedule:
    - cron: '0 21 * * *'  # æ¯å¤© UTC 21:00ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š5ç‚¹ï¼‰
  workflow_dispatch:

permissions:
  contents: write  # å…è®¸æ¨é€ CSV æ•°æ®

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "-------------------------------------------"
          echo "Installing Python dependencies..."
          echo "-------------------------------------------"
          pip install -r requirements.txt

      - name: ğŸš€ Run daily monitor
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          ALERT_THRESHOLD: ${{ secrets.ALERT_THRESHOLD || '-0.03' }}
        run: |
          echo "-------------------------------------------"
          echo "ğŸ“Š Running market monitor script..."
          echo "-------------------------------------------"
          python ndx_monitor.py

      - name: ğŸ’¾ Commit and push market data
        run: |
          echo "-------------------------------------------"
          echo "ğŸ’¾ Checking for new data and committing..."
          echo "-------------------------------------------"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          if [ -f "market_daily.csv" ]; then
            git add market_daily.csv
            git commit -m "Update market daily data $(date '+%Y-%m-%d')" && \
            git push origin HEAD:${{ github.ref_name }} && \
            echo "âœ… Data successfully pushed to repository."
          else
            echo "â„¹ï¸ No CSV generated (possibly non-trading day)."
          fi

      - name: âœ… Final summary
        run: |
          echo ""
          echo "==========================================="
          echo "ğŸ“ˆ å¸‚åœºæ—¥æŠ¥æ‰§è¡Œå®Œæˆ âœ…"
          echo "==========================================="
